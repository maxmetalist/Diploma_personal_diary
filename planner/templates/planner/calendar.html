{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - –õ–∏—á–Ω—ã–µ –∑–∞–ø–∏—Å—É–ª—å–∫–∏{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<style>
    #calendar {
        background: white;
        border-radius: 8px;
        padding: 20px;
        min-height: 600px;
    }

    .fc .fc-toolbar-title {
        color: #333 !important;
        font-weight: 600 !important;
        font-size: 1.5em !important;
    }

    .fc .fc-button {
        background: #0d6efd !important;
        border: none !important;
        border-radius: 6px !important;
        font-weight: 500 !important;
    }

    .fc .fc-button:hover {
        background: #0b5ed7 !important;
        transform: translateY(-1px);
    }

    .fc .fc-button:active {
        background: #0a58ca !important;
    }

    .fc .fc-day-today {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }

    .fc .fc-day-today .fc-daygrid-day-number {
        color: #fd7e14 !important;
        font-weight: bold !important;
    }

    .fc-event {
        cursor: pointer !important;
        border-radius: 6px !important;
        border: none !important;
        font-size: 0.85em !important;
        padding: 4px 6px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .task-priority-high {
        background: linear-gradient(135deg, #dc3545, #c82333) !important;
        color: white !important;
        border-left: 3px solid #a71e2a !important;
    }

    .task-priority-medium {
        background: linear-gradient(135deg, #ffc107, #e0a800) !important;
        color: black !important;
        border-left: 3px solid #d39e00 !important;
    }

    .task-priority-low {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7) !important;
        color: white !important;
        border-left: 3px solid #0a58ca !important;
    }

    .fc-daygrid-day:hover {
        background-color: rgba(13, 110, 253, 0.05) !important;
    }

    .task-list-item {
        border-left: 4px solid;
        margin-bottom: 12px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .task-list-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .border-left-high { border-left-color: #dc3545 !important; }
    .border-left-medium { border-left-color: #ffc107 !important; }
    .border-left-low { border-left-color: #0d6efd !important; }

    .fc-event-content {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .priority-high { background: #dc3545; }
    .priority-medium { background: #ffc107; }
    .priority-low { background: #0d6efd; }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>üìÖ {{ title }}</h1>
                    <p class="text-muted mb-0">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</p>
                </div>
                <div>
                    <a href="{% url 'planner:task_list' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-list me-1"></i>–í—Å–µ –∑–∞–¥–∞—á–∏
                    </a>
                    <a href="{% url 'planner:task_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                    </a>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–¥–∞—á –¥–Ω—è -->
            <div class="modal fade" id="dayTasksModal" tabindex="-1" aria-labelledby="dayTasksModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="dayTasksModalLabel">
                                <i class="fas fa-calendar-day me-2"></i>–ó–∞–¥–∞—á–∏ –Ω–∞ <span id="modalDate"></span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="dayTasksModalBody">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary mb-3"></div>
                                <p class="text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏...</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <a href="#" id="createTaskLink" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div id="calendar">
                        <div class="text-center py-5" id="calendarFallback">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                            <p class="text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js"></script>

<script>
let calendarInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø ===');
    initializeCalendar();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');

    if (!calendarEl) {
        showError('–≠–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    if (typeof FullCalendar === 'undefined') {
        showError('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ FullCalendar –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
    }

    try {
        const fallback = document.getElementById('calendarFallback');
        if (fallback) fallback.innerHTML = '<p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>';

        let eventsData = [];
        try {
            eventsData = {{ calendar_events|safe }};
            console.log('–°–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', eventsData.length);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö events:', e);
            eventsData = [];
        }

        const calendarConfig = {
            initialView: 'dayGridMonth',
            locale: 'ru',
            firstDay: 1,
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: '–°–µ–≥–æ–¥–Ω—è',
                month: '–ú–µ—Å—è—Ü',
                week: '–ù–µ–¥–µ–ª—è',
                day: '–î–µ–Ω—å'
            },
            events: eventsData,
            navLinks: true,
            editable: true,
            selectable: true,
            dayMaxEvents: 3,
            showNonCurrentDates: true,
            fixedWeekCount: false,

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            eventDrop: function(info) {
                console.log('üîÑ –°–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ:', info.event);
                console.log('–°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞:', info.oldEvent.start);
                console.log('–ù–æ–≤–∞—è –¥–∞—Ç–∞:', info.event.start);

                updateTaskDate(info.event, info.revert);
            },

            eventResize: function(info) {
                console.log('üìÖ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞:', info.event);
                updateTaskDate(info.event, info.revert);
            },

            eventClick: function(info) {
                console.log('–ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é:', info.event);
                info.jsEvent.preventDefault();

                // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
                info.el.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    info.el.style.transform = 'scale(1)';
                }, 150);

                if (info.event.url && info.event.url !== '#') {
                    window.location.href = info.event.url;
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                    showTaskDetails(info.event);
                }
            },

            dateClick: function(info) {
                console.log('–ö–ª–∏–∫ –ø–æ –¥–∞—Ç–µ:', info.dateStr);

                // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
                info.dayEl.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    info.dayEl.style.transform = 'scale(1)';
                    showDayTasks(info.dateStr);
                }, 150);
            },

            eventDidMount: function(info) {
                const priority = info.event.extendedProps.priority;
                if (priority) {
                    info.el.classList.add('task-priority-' + priority);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                info.el.style.cursor = 'grab';

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                let icon = '';
                if (priority === 'high') icon = 'üî¥';
                else if (priority === 'medium') icon = 'üü°';
                else if (priority === 'low') icon = 'üîµ';

                if (icon && info.el.querySelector('.fc-event-title')) {
                    const titleEl = info.el.querySelector('.fc-event-title');
                    titleEl.innerHTML = `<span class="fc-event-content">${icon} ${info.event.title}</span>`;
                }
            },

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–µ–Ω–∏—è
            eventDragStart: function(info) {
                console.log('üé¨ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è:', info.event.title);
                info.el.style.cursor = 'grabbing';
                info.el.style.opacity = '0.7';
            },

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            eventDragStop: function(info) {
                console.log('üèÅ –ö–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è:', info.event.title);
                info.el.style.cursor = 'grab';
                info.el.style.opacity = '1';
            },

            datesSet: function(info) {
                console.log('–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:', info.start, info.end);
                hideSpinner();
            },

            loading: function(isLoading) {
                if (!isLoading) {
                    hideSpinner();
                }
            }
        };

        calendarInstance = new FullCalendar.Calendar(calendarEl, calendarConfig);
        calendarInstance.render();

        console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        setTimeout(hideSpinner, 1000);

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
        showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è: ' + error.message);
    }
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–¢–´ –ó–ê–î–ê–ß–ò
function updateTaskDate(event, revertFunction) {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∑–∞–¥–∞—á–∏...');

    const taskId = event.id;
    const newDate = event.startStr; // –ù–æ–≤–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
    const oldDate = event.oldEvent ? event.oldEvent.startStr : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    console.log(`–ó–∞–¥–∞—á–∞ ${taskId}: ${oldDate} ‚Üí ${newDate}`);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    showNotification('–û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∑–∞–¥–∞—á–∏...', 'info', 2000);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/planner/calendar/update-date/${taskId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            due_date: newDate,
            old_date: oldDate
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('‚úÖ –î–∞—Ç–∞ –∑–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            showNotification('–î–∞—Ç–∞ –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success', 3000);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Å–æ–±—ã—Ç–∏—è –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è –Ω–æ–≤—ã–π —Ü–≤–µ—Ç
            if (data.color && event.setProp) {
                event.setProp('color', data.color);
                console.log('üé® –¶–≤–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω:', data.color);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º URL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (data.url && event.setProp) {
                event.setProp('url', data.url);
            }

        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã:', data.error);
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error', 5000);
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
            if (revertFunction) {
                revertFunction();
                console.log('‚Ü©Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞–Ω–æ');
            }
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã', 'error', 5000);
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        if (revertFunction) {
            revertFunction();
            console.log('‚Ü©Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏');
        }
    });
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–û–õ–£–ß–ï–ù–ò–ï CSRF –¢–û–ö–ï–ù–ê
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }

    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];

    if (cookieValue) {
        return cookieValue;
    }

    console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
    showNotification('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', 'error');
    return '';
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–û–ö–ê–ó –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
function showNotification(message, type = 'info', duration = 5000) {
    console.log(`üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ [${type}]: ${message}`);

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let container = document.getElementById('notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notifications-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.cssText = 'z-index: 1060; max-width: 350px;';
        document.body.appendChild(container);
    }

    const notificationId = 'notification-' + Date.now();
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const icon = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è',
        'info': '‚ÑπÔ∏è'
    }[type] || '‚ÑπÔ∏è';

    const notificationHTML = `
        <div id="${notificationId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <span class="me-2">${icon}</span>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', notificationHTML);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        notification.style.transition = 'all 0.3s ease';

        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 10);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    if (duration > 0) {
        setTimeout(() => {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
    }

    return notificationId;
}

function hideSpinner() {
    const fallback = document.getElementById('calendarFallback');
    if (fallback) {
        console.log('üîÑ –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞');
        fallback.style.display = 'none';
        console.log('‚úÖ –°–ø–∏–Ω–Ω–µ—Ä —Å–∫—Ä—ã—Ç');
    }
}

function showDayTasks(dateStr) {
    console.log('üîÑ –ù–∞—á–∞–ª–æ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ –∑–∞–¥–∞—á');
    console.log('–ü–æ–∫–∞–∑ –∑–∞–¥–∞—á –¥–ª—è –¥–∞—Ç—ã:', dateStr);

    const modal = new bootstrap.Modal(document.getElementById('dayTasksModal'));
    const modalDateEl = document.getElementById('modalDate');
    const modalBody = document.getElementById('dayTasksModalBody');
    const createTaskLink = document.getElementById('createTaskLink');

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    const date = new Date(dateStr);
    const formattedDate = date.toLocaleDateString('ru-RU', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    modalDateEl.textContent = formattedDate;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    createTaskLink.href = `/planner/task/create/?due_date=${dateStr}`;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3"></div>
            <p class="text-muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏...</p>
        </div>
    `;

    modal.show();

    // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á
    fetch(`/planner/api/tasks-by-date/?date=${dateStr}`)
        .then(response => {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            return response.json();
        })
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let tasksHtml = `
                    <div class="mb-3">
                        <strong><i class="fas fa-tasks me-2"></i>–ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: ${data.tasks.length}</strong>
                    </div>
                `;

                data.tasks.forEach((task, index) => {
                    const dueTime = task.due_date ? new Date(task.due_date).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                    tasksHtml += `
                        <div class="task-list-item border-left-${task.priority}" style="animation-delay: ${index * 0.1}s">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold">${escapeHtml(task.title)}</h6>
                                    ${task.description ? `<p class="text-muted small mb-2">${escapeHtml(task.description)}</p>` : ''}
                                    <div class="small">
                                        <span class="badge bg-${getPriorityClass(task.priority)} me-2">
                                            ${task.priority_display}
                                        </span>
                                        <span class="badge bg-${getStatusClass(task.status)} me-2">
                                            ${task.status_display}
                                        </span>
                                        ${dueTime ? `<span class="text-muted"><i class="fas fa-clock me-1"></i>${dueTime}</span>` : ''}
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <a href="/planner/task/${task.id}/edit/" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });

                modalBody.innerHTML = tasksHtml;
            } else {
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-day fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–¥–∞—á –Ω–µ—Ç</h5>
                        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á</h5>
                    <p class="mb-0">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                </div>
            `;
        });
}

function showTaskDetails(event) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    const modal = new bootstrap.Modal(document.getElementById('dayTasksModal'));
    const modalDateEl = document.getElementById('modalDate');
    const modalBody = document.getElementById('dayTasksModalBody');
    const createTaskLink = document.getElementById('createTaskLink');

    modalDateEl.textContent = '–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏';
    createTaskLink.href = `/planner/task/${event.id}/edit/`;
    createTaskLink.innerHTML = '<i class="fas fa-edit me-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';

    const eventDate = event.start ? new Date(event.start).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';

    modalBody.innerHTML = `
        <div class="task-details">
            <h5 class="mb-3">${escapeHtml(event.title)}</h5>
            <div class="mb-3">
                <strong>–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> ${eventDate}
            </div>
            <div class="mb-3">
                <strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong>
                <span class="badge bg-${getPriorityClass(event.extendedProps.priority)}">
                    ${getPriorityDisplay(event.extendedProps.priority)}
                </span>
            </div>
            ${event.extendedProps.description ? `
                <div class="mb-3">
                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                    <p class="mt-1">${escapeHtml(event.extendedProps.description)}</p>
                </div>
            ` : ''}
        </div>
    `;

    modal.show();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getPriorityClass(priority) {
    const classes = { 'high': 'danger', 'medium': 'warning', 'low': 'primary' };
    return classes[priority] || 'secondary';
}

function getStatusClass(status) {
    const classes = { 'done': 'success', 'in_progress': 'primary', 'todo': 'secondary' };
    return classes[status] || 'secondary';
}

function getPriorityDisplay(priority) {
    const displays = { 'high': '–í—ã—Å–æ–∫–∏–π', 'medium': '–°—Ä–µ–¥–Ω–∏–π', 'low': '–ù–∏–∑–∫–∏–π' };
    return displays[priority] || '–ù–µ —É–∫–∞–∑–∞–Ω';
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function showError(message) {
    const calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        calendarEl.innerHTML = `
            <div class="alert alert-danger">
                <h4>‚ùå –û—à–∏–±–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</h4>
                <p>${message}</p>
                <button onclick="location.reload()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                <button onclick="initializeCalendar()" class="btn btn-outline-primary">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</button>
            </div>
        `;
    }
}
</script>
{% endblock %}