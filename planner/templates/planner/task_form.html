{% extends 'base.html' %}

{% block title %}{{ title }} - –õ–∏—á–Ω—ã–µ –∑–∞–ø–∏—Å—É–ª—å–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">{{ title }}</h2>
                </div>
                <div class="card-body">
                    <form method="post" id="taskForm">
                        {% csrf_token %}

                        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">
                                        {{ form.title.label }}
                                    </label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.title.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.priority.id_for_label }}" class="form-label">
                                        {{ form.priority.label }}
                                    </label>
                                    {{ form.priority }}
                                    {% if form.priority.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.priority.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="alert alert-danger mt-1">
                                {{ form.description.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                        {{ form.due_date.label }}
                                    </label>
                                    {{ form.due_date }}
                                    {% if form.due_date.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.due_date.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">
                                        {{ form.status.label }}
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.status.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏ -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.is_recurring.id_for_label }}" class="form-label">
                                        {{ form.is_recurring.label }}
                                    </label>
                                    {{ form.is_recurring }}
                                    {% if form.is_recurring.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.is_recurring.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- –ü–æ–ª—è –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                                <div id="weeklyFields" class="mb-3" style="display: none;">
                                    <label class="form-label">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div class="form-check">
                                            {{ form.monday }}
                                            <label class="form-check-label" for="{{ form.monday.id_for_label }}">
                                                –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.tuesday }}
                                            <label class="form-check-label" for="{{ form.tuesday.id_for_label }}">
                                                –í—Ç–æ—Ä–Ω–∏–∫
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.wednesday }}
                                            <label class="form-check-label" for="{{ form.wednesday.id_for_label }}">
                                                –°—Ä–µ–¥–∞
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.thursday }}
                                            <label class="form-check-label" for="{{ form.thursday.id_for_label }}">
                                                –ß–µ—Ç–≤–µ—Ä–≥
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.friday }}
                                            <label class="form-check-label" for="{{ form.friday.id_for_label }}">
                                                –ü—è—Ç–Ω–∏—Ü–∞
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.saturday }}
                                            <label class="form-check-label" for="{{ form.saturday.id_for_label }}">
                                                –°—É–±–±–æ—Ç–∞
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.sunday }}
                                            <label class="form-check-label" for="{{ form.sunday.id_for_label }}">
                                                –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- –ü–æ–ª—è –¥–ª—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                                <div id="monthlyFields" class="mb-3" style="display: none;">
                                    <label class="form-label">–ß–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞</label>
                                    <div class="mb-2">
                                        <small class="text-muted">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</small>
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="selectAllMonthDays()">–í—Å–µ</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekdays()">–ë—É–¥–Ω–∏</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekend()">–í—ã—Ö–æ–¥–Ω—ã–µ</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearMonthDays()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                    </div>
                                    <div style="max-height: 200px; overflow-y: auto;" class="border p-3 rounded">
                                        <div class="row">
                                            {% for day in "12345678910111213141516171819202122232425262728293031"|make_list %}
                                            <div class="col-4 col-sm-3 col-md-2 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input monthly-day" type="checkbox"
                                                           name="monthly_days_field" value="{{ day }}"
                                                           id="monthDay{{ day }}"
                                                           {% if day in form.monthly_days_field.value %}checked{% endif %}>
                                                    <label class="form-check-label" for="monthDay{{ day }}">
                                                        {{ day }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π -->
                                <div id="recurrenceEndDateField" class="mb-3" style="display: none;">
                                    <label for="{{ form.recurrence_end_date.id_for_label }}" class="form-label">
                                        {{ form.recurrence_end_date.label }}
                                    </label>
                                    {{ form.recurrence_end_date }}
                                    {% if form.recurrence_end_date.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.recurrence_end_date.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.notification_setting.id_for_label }}" class="form-label">
                                        {{ form.notification_setting.label }}
                                    </label>
                                    {{ form.notification_setting }}
                                    {% if form.notification_setting.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.notification_setting.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div id="customNotificationTimeField" class="mb-3" style="display: none;">
                                    <label for="{{ form.custom_notification_time.id_for_label }}" class="form-label">
                                        {{ form.custom_notification_time.label }}
                                    </label>
                                    {{ form.custom_notification_time }}
                                    {% if form.custom_notification_time.errors %}
                                    <div class="alert alert-danger mt-1">
                                        {{ form.custom_notification_time.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <a href="{% url 'planner:task_list' %}" class="btn btn-secondary">
                                ‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
function toggleRecurrenceFields() {
    const recurrenceType = document.getElementById('id_is_recurring').value;

    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
    document.getElementById('weeklyFields').style.display = 'none';
    document.getElementById('monthlyFields').style.display = 'none';
    document.getElementById('recurrenceEndDateField').style.display = 'none';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
    if (recurrenceType === 'weekly') {
        document.getElementById('weeklyFields').style.display = 'block';
        document.getElementById('recurrenceEndDateField').style.display = 'block';
    } else if (recurrenceType === 'monthly') {
        document.getElementById('monthlyFields').style.display = 'block';
        document.getElementById('recurrenceEndDateField').style.display = 'block';
    } else if (recurrenceType === 'daily') {
        document.getElementById('recurrenceEndDateField').style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function toggleNotificationFields() {
    const notificationType = document.getElementById('id_notification_setting').value;
    document.getElementById('customNotificationTimeField').style.display =
        (notificationType === 'at_time') ? 'block' : 'none';
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ —á–∏—Å–µ–ª –º–µ—Å—è—Ü–∞
function selectAllMonthDays() {
    document.querySelectorAll('.monthly-day').forEach(checkbox => {
        checkbox.checked = true;
    });
}

function selectWeekdays() {
    const weekdays = ['1', '2', '3', '4', '5', '8', '9', '10', '11', '12', '15', '16', '17', '18', '19', '22', '23', '24', '25', '26', '29', '30', '31'];
    document.querySelectorAll('.monthly-day').forEach(checkbox => {
        checkbox.checked = weekdays.includes(checkbox.value);
    });
}

function selectWeekend() {
    const weekend = ['6', '7', '13', '14', '20', '21', '27', '28'];
    document.querySelectorAll('.monthly-day').forEach(checkbox => {
        checkbox.checked = weekend.includes(checkbox.value);
    });
}

function clearMonthDays() {
    document.querySelectorAll('.monthly-day').forEach(checkbox => {
        checkbox.checked = false;
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è
    toggleRecurrenceFields();
    toggleNotificationFields();

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è due_date, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    const dueDateField = document.getElementById('id_due_date');
    if (dueDateField && !dueDateField.value) {
        const now = new Date();
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ 2 —á–∞—Å–∞ –≤–ø–µ—Ä–µ–¥ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
        now.setHours(now.getHours() + 2);
        now.setMinutes(0);
        dueDateField.value = now.toISOString().slice(0, 16);
    }
});
</script>

<style>
.form-control, .form-select {
    border-radius: 8px;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
{% endblock %}